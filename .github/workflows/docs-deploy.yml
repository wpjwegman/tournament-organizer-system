name: "ðŸ“š Documentation Deploy Fixed"

on:
  push:
    branches: [master]
    paths:
      - 'documents/**/*.md'
      - 'documents/mkdocs.yml'
      - 'documents/pyproject.toml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes detected'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-docs:
    name: ðŸ—ï¸ Build Documentation Site
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for git-revision-date-localized plugin

    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ—ï¸ Build Documentation Container
      run: |
        cd documents
        docker build -t localhost/docs-quality:latest -f Containerfile .

    - name: ðŸ“š Generate Documentation Site
      run: |
        cd documents
        
        # Remove existing site directory and recreate it
        rm -rf site
        mkdir -p site
        
        # Generate the complete documentation site using our container
        # Build site in temporary location and copy back to avoid permission issues
        docker run --rm \
          -v "${{ github.workspace }}:/workspace" \
          -w /tmp \
          localhost/docs-quality:latest bash -c "
          echo '--- Building Documentation Site ---' &&
          
          # Copy documents to tmp for building
          echo 'ðŸ“¦ Copying project to build location...' &&
          cp -r /workspace/documents /tmp/build &&
          cd /tmp/build &&
          
          echo 'ðŸ“¦ Setting up Python environment...' &&
          /usr/local/bin/uv sync &&
          
          echo 'ðŸ“š Building MkDocs site...' &&
          /usr/local/bin/uv run mkdocs build --clean --strict &&
          
          echo 'ðŸ“¤ Copying site back to workspace...' &&
          rm -rf /workspace/documents/site/* &&
          cp -r site/* /workspace/documents/site/ &&
          
          echo 'âœ… Documentation site built successfully'
          "

    - name: ðŸ” Validate Generated Site
      run: |
        cd documents/site
        
        # Verify the site was generated correctly
        if [ ! -f "index.html" ]; then
          echo "::error::Site index.html not found"
          exit 1
        fi
        
        # Check for common issues
        TOTAL_FILES=$(find . -name "*.html" | wc -l)
        echo "::notice::Generated $TOTAL_FILES HTML files"
        
        # Verify key pages exist
        KEY_PAGES=("index.html" "domains/index.html")
        for PAGE in "${KEY_PAGES[@]}"; do
          if [ -f "$PAGE" ]; then
            echo "âœ… Key page found: $PAGE"
          else
            echo "::warning::Key page missing: $PAGE"
          fi
        done

    - name: ðŸ“„ Setup Pages
      uses: actions/configure-pages@v4

    - name: ðŸ“¤ Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: documents/site

    - name: ðŸ“Š Generate Deployment Report
      run: |
        cd documents
        
        # Create deployment report
        cat > deployment_report.md << 'EOF'
        # ðŸ“š Documentation Deployment Report

        **Repository:** ${{ github.repository }}
        **Branch:** `${{ github.ref_name }}`
        **Commit:** `${{ github.sha }}`
        **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

        ## Deployment Details

        ### Build Information
        - **Trigger**: ${{ github.event_name }}
        - **Runner**: ${{ runner.os }}
        - **Container**: `localhost/docs-quality:latest`
        - **MkDocs**: Material theme with enterprise configuration

        ### Site Statistics
        EOF
        
        # Add site statistics
        if [ -d "site" ]; then
          TOTAL_HTML=$(find site -name "*.html" | wc -l)
          TOTAL_SIZE=$(du -sh site | cut -f1)
          
          cat >> deployment_report.md << EOF
        - **Total Pages**: $TOTAL_HTML HTML files
        - **Site Size**: $TOTAL_SIZE
        - **Build Status**: âœ… Success
        
        ### Quality Validation
        - âœ… **Container Build**: Documentation container built successfully
        - âœ… **Site Generation**: MkDocs build completed without errors
        - âœ… **File Validation**: Key pages verified
        - âœ… **Artifact Upload**: Site artifact prepared for deployment
        EOF
        else
          echo "- **Build Status**: âŒ Failed - site directory not found" >> deployment_report.md
        fi

    - name: ðŸ“„ Upload Deployment Report
      uses: actions/upload-artifact@v4
      with:
        name: deployment-report
        path: documents/deployment_report.md
        retention-days: 30

  deploy-docs:
    name: ðŸš€ Deploy to GitHub Pages
    needs: build-docs
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: ðŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: ðŸ’¡ Deployment Summary
      run: |
        echo "## ðŸ“š Documentation Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployment Success" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Site URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Build**: Container-based MkDocs generation" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Quality**: Validated during build process" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Artifact**: Uploaded to GitHub Pages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Enterprise Standards" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”’ **Security**: Container-based build environment" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“Š **Quality**: Strict MkDocs validation" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŽ¯ **Automation**: Deploy only on master branch changes" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“š **Documentation**: Complete site with domain structure" >> $GITHUB_STEP_SUMMARY
