# Tournament Organizer Documentation - Podman Container
# Professional Podman-based development environment

FROM python:3.13-slim as base

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js for markdownlint-cli2
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs

# Install markdownlint-cli2 globally
RUN npm install -g markdownlint-cli2

# Install uv
RUN pip install uv

# Create non-root user
RUN useradd --create-home --shell /bin/bash tournament
USER tournament
WORKDIR /home/tournament

# Development stage
FROM base as development

# Copy dependency files
COPY --chown=tournament:tournament pyproject.toml uv.lock ./

# Install dependencies with uv
RUN uv sync --frozen

# Copy source code
COPY --chown=tournament:tournament . ./

# Default command
CMD ["bash"]

# Production build stage
FROM development as production

# Run quality checks and build
RUN uv run pre-commit run --all-files || true
RUN uv run python scripts/validation/check_nav_orphans.py
RUN uv run python scripts/validation/check_no_frontmatter_title.py
RUN uv run mkdocs build --strict

# Serve stage
FROM nginx:alpine as serve
COPY --from=production /home/tournament/site /usr/share/nginx/html
EXPOSE 80
HEALTHCHECK --interval=30s --timeout=3s \
    CMD curl -f http://localhost/ || exit 1
